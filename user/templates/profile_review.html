{% extends 'base.html' %} {% load static %} {% block content %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<section class="py-5">
  <div class="container">
    <!-- Breadcrumbs -->
    <ol class="breadcrumb pl-0  justify-content-start">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
      <li class="breadcrumb-item active">Reviews</li>
    </ol>
  
        <div class="card shadow">
          <div class="card-body">
              <h6>
                  <span class="text-primary">My</span> REVIEWS
              </h6>
              <span id="internal_review"></span>
          </div>
        </div>


  </div>
  </div>
</section>

<script>
  const DEFAULT_AVATAR = 'https://s3-media3.fl.yelpcdn.com/photo/O8CmQtEeOUvMTFk0iMn5sw/o.jpg';
  const isNull = el => el === 'null' || el === null || el === undefined;
    /**
     * Rating box view
     * @param {review-id} string
     * @param {profile-img} string
     * @param {profile-img-alt} string
     * @param {profile-url} string
     * @param {time-created} string
     * @param {user-name} string
     * @param {user-rating} string
     * @param {review-text} string
     * @param {editable} boolean - if this rating comment is left by the login user, this comment should be editable
     */
    class RatingReview extends HTMLElement {
  constructor () {
    super();
    this.attachShadow({ mode: 'open' });

    this.addStyles();

    this.rootDiv = document.createElement('div');
    this.rootDiv.className = 'media d-block d-sm-flex review';

    // left side
    const userProfile = document.createElement('div');
    userProfile.className = 'text-md-center mr-4 mr-xl-5';
    this.avatar = document.createElement('img');
    this.avatar.className = 'd-block img-thumbnail p-2';

    this.avatar.style = "width:120px; height:120px";
    this.avatar.src = this.getAttribute('profile-img') || DEFAULT_AVATAR;
    this.avatar.alt = this.getAttribute('profile-img-alt') || '';
    this.createRatingTimestamp = document.createElement('span');
    this.createRatingTimestamp.className = 'text-uppercase text-muted text-sm';
    this.createRatingTimestamp.innerText = this.getAttribute('time-created') || '';
    
    userProfile.appendChild(this.avatar);
    userProfile.appendChild(this.createRatingTimestamp);

    // right side
    const ratingBody = document.createElement('div');
    ratingBody.className = 'media-body';
    
    // author link
    const author = document.createElement('h6');
    author.className = 'mt-2 mb-1';

    this.authorProfileLink = document.createElement('a');
    this.authorProfileLink.href = this.getAttribute('profile-url') || DEFAULT_AVATAR;
    this.authorProfileLink.innerText = this.getAttribute('user-name') || '';

    author.appendChild(this.authorProfileLink);
    ratingBody.appendChild(author);

    // rating stars
    this.ratingStars = document.createElement('div');
    const rating = Number(this.getAttribute('user-rating') || '');
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('i');
      star.className = 'fa fa-xs fa-star';
      star.classList.add(i < rating ? 'text-primary' : 'text-gray-200');
      this.ratingStars.appendChild(star);
    }
    ratingBody.appendChild(this.ratingStars);

    // comments
    this.comments = document.createElement('p');
    this.comments.setAttribute('style', 'display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;');
    this.comments.className = 'text-muted text-sm';
    this.comments.innerText = this.getAttribute('review-text');
    
    ratingBody.appendChild(this.comments);

    this.rootDiv.appendChild(userProfile);
    this.rootDiv.appendChild(ratingBody);

    if (this.hasAttribute('editable')) {
      this.attachOptionButton();
    }

    this.shadowRoot.appendChild(this.rootDiv);
  }

  static get observedAttributes() {
    return ['profile-img', 'profile-img-alt', 'profile-url', 'time-created', 'user-name', 'user-rating', 'review-text', 'editable'];
  }

  attributeChangedCallback(name, oldValue, newValue) {
    if (name === 'profile-img') {
      this.avatar.setAttribute('src', isNull(newValue) ? DEFAULT_AVATAR : newValue);
    } else if (name === 'profile-img-alt') {
      this.avatar.setAttribute('alt', newValue || '');
    } else if (name === 'time-created') {
      this.createRatingTimestamp.innerText = newValue || '';
    } else if (name === 'profile-url') {
      this.authorProfileLink.setAttribute('href', newValue || '');
    } else if (name === 'user-name') {
      this.authorProfileLink.innerText = newValue || '';
    } else if (name === 'user-rating') {
      const rating = Number(newValue || 0);
      new Array().forEach.call(this.ratingStars.children, (el, index) => {
        if (index < rating) {
          el.classList.replace('text-gray-200', 'text-primary');
        } else {
          el.classList.replace('text-primary', 'text-gray-200');
        }
      });
    } else if (name === 'review-text') {
      this.comments.innerText = newValue || '';
    } else if (name === 'editable') {
      this.attachOptionButton();
    }
  }

  attachOptionButton () {
    if (this.optionButton) return;
    // option button
    const optionButtonWrapper = document.createElement('div');
    optionButtonWrapper.setAttribute('class', 'dropdown');

    this.optionButton = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    this.optionButton.setAttribute('viewBox', '0 0 24 24');
    this.optionButton.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    this.optionButton.setAttribute('style', 'display: inline-block; width: 1rem; height: 1rem; cursor: pointer;');
    this.optionButton.setAttribute('class', 'dropdown-toggle');
    this.optionButton.setAttribute('type', 'button');

    const optionWrapper = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    const optionPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    optionPath.setAttribute('d', 'M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z');
    optionWrapper.appendChild(optionPath);
    this.optionButton.appendChild(optionWrapper);

    // dropdown button wrapper
    const dropdownWrapper = document.createElement('div');
    dropdownWrapper.setAttribute('class', 'dropdown-menu p-0');

    this.deleteForm = document.createElement('form');
    this.deleteForm.setAttribute('action', `/restaurant/profile/${this.getAttribute('restaurant-id')}/comment/${this.getAttribute('review-id')}/delete`);

    ['Edit', 'Delete'].forEach((el, index) => {
      const anchor = document.createElement('a');
      anchor.setAttribute('class', 'dropdown-item small py-2');
      anchor.setAttribute('href', '#');      
      anchor.innerText = el;
      if (index === 0) {
        anchor.addEventListener('click', () => {
          $('#exampleModal').modal('toggle');
          const rating = document.querySelector('select[name="rating"]');
          rating.value = this.getAttribute('user-rating');
          rating.dispatchEvent(new Event('change'));
          const content = document.querySelector('textarea[name="content"]');
          content.value = this.getAttribute('review-text');
          content.dispatchEvent(new Event('change'));
          document.forms['rating-form'].setAttribute('action', `/restaurant/profile/${this.getAttribute('restaurant-id')}/comment/${this.getAttribute('review-id')}/put`);
        });
      } else {
        anchor.addEventListener('click', () => this.deleteForm.submit());
      }
      dropdownWrapper.appendChild(anchor);
    });

    optionButtonWrapper.appendChild(this.optionButton);
    optionButtonWrapper.appendChild(dropdownWrapper);
    optionButtonWrapper.appendChild(this.deleteForm);
    optionButtonWrapper.addEventListener('mouseover', () => {
      dropdownWrapper.classList.add('show');
    });
    dropdownWrapper.addEventListener('mouseout', () => {
      dropdownWrapper.classList.remove('show');
    });

    this.rootDiv.appendChild(optionButtonWrapper);
  }

  // add web component styles
  addStyles () {
    const styleLinks = [
      'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css',
      '/static/css/style.default.452e11c7.css',
      '/static/css/all.css',
      '/static/css/custom.0a822280.css',
    ]

    styleLinks.forEach(el => {
      const styles = document.createElement('link');
      styles.setAttribute('rel', 'stylesheet');
      styles.setAttribute('href', el);
      this.shadowRoot.appendChild(styles);
    });
  }
};
    customElements.define('rating-review', RatingReview);
    
    const userId = Number('{{ user_id | safe }}');
    const internalReviews = {{ internal_reviews | safe }};
    internalReviews.forEach(review => {
      const reviewWrapper = document.getElementById('internal_review');
      const ratingReview = document.createElement('rating-review');
      ratingReview.setAttribute('profile-img', review.restaurant__yelp_detail__img_url);
      ratingReview.setAttribute('profile-img-alt', review.restaurant__restaurant_name);
      ratingReview.setAttribute('user-name', review.restaurant__restaurant_name);
      ratingReview.setAttribute('time-created', review.time);
      ratingReview.setAttribute('user-rating', review.rating);
      ratingReview.setAttribute('review-text', review.content);
      ratingReview.setAttribute('review-id', review.id);
      const temp = "../restaurant/profile/" + review.restaurant__id;
      ratingReview.setAttribute('profile-url', temp);
      if (userId === review.user) {
        ratingReview.setAttribute('editable', 'editable');
      }
      reviewWrapper.appendChild(ratingReview);
    });
    </script>



{% endblock %}